<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fantasy MMA Leaderboard</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    .team-header { cursor: pointer; background: #ddd; padding: 10px; margin-top: 10px; font-weight: bold; }
    .fighter-table { display: none; margin-bottom: 20px; width: 100%; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Fantasy MMA – 2025 Season</h1>

  <h2>Team Leaderboard</h2>
  <table id="team-table">
    <thead>
      <tr><th>Team</th><th>Total Points</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Teams & Fighters</h2>
  <div id="teams-container"></div>
  <div id="error-message" class="error"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // -----------------------------
    // Replace these with your keys
    // -----------------------------
    const SUPABASE_URL = "https://hbhbwuijvbkenncwtbfw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiaGJ3dWlqdmJrZW5uY3d0YmZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyOTg5NzksImV4cCI6MjA4Mjg3NDk3OX0.YwKDkbODTXNbQySb8O41MFH1C4dTKnGQ1jZqn3_-orM";

    // Use a different variable name to avoid redeclaration
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Heaviest → lightest order (utility last)
    const weightOrder = [
      "Heavyweight","L. Heavyweight","Middleweight","Welterweight",
      "Lightweight","Featherweight","Bantamweight","Flyweight",
      "W. Bantamweight","W. Flyweight","W. Straweight","M Utility","W Utility"
    ];

    async function loadData() {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = '';

      // Fetch team leaderboard
      const { data: teams, error: teamError } = await supabaseClient
        .from('season_team_summary')
        .select('*')
        .order('team_points', { ascending: false });

      if (teamError) {
        console.error(teamError);
        errorDiv.textContent = `Error fetching team data: ${teamError.message}`;
        return;
      }

      // Populate team leaderboard
      const teamTbody = document.querySelector('#team-table tbody');
      teamTbody.innerHTML = '';
      teams.forEach(team => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${team.team_name}</td><td>${team.team_points}</td>`;
        teamTbody.appendChild(tr);
      });

      // Fetch fighters
      const { data: fighters, error: fighterError } = await supabaseClient
        .from('season_fighter_summary')
        .select('*');

      if (fighterError) {
        console.error(fighterError);
        errorDiv.textContent = `Error fetching fighters: ${fighterError.message}`;
        return;
      }

      // Group fighters by team
      const fightersByTeam = {};
      fighters.forEach(f => {
        if (!fightersByTeam[f.team_name]) fightersByTeam[f.team_name] = [];
        fightersByTeam[f.team_name].push(f);
      });

      const container = document.getElementById('teams-container');
      container.innerHTML = '';

      for (const team of teams) {
        const teamDiv = document.createElement('div');

        // Collapsible header
        const header = document.createElement('div');
        header.className = 'team-header';
        header.textContent = `${team.team_name} (${team.team_points} pts)`;
        header.addEventListener('click', () => {
          table.style.display = table.style.display === 'none' ? 'table' : 'none';
        });

        // Fighter table
        const table = document.createElement('table');
        table.className = 'fighter-table';
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr><th>Fighter</th><th>Roster Slot</th><th>Points</th></tr>`;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        // Sort: weight order → utility last → points descending
        const sortedFighters = (fightersByTeam[team.team_name] || []).sort((a,b) => {
          const aIndex = weightOrder.indexOf(a.roster_slot);
          const bIndex = weightOrder.indexOf(b.roster_slot);
          if (aIndex !== bIndex) return aIndex - bIndex; 
          return b.points_total - a.points_total;
        });

        sortedFighters.forEach(f => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${f.fighter_name}</td><td>${f.roster_slot}</td><td>${f.points_total}</td>`;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        teamDiv.appendChild(header);
        teamDiv.appendChild(table);
        container.appendChild(teamDiv);
      }
    }

    loadData();
    setInterval(loadData, 30000); // refresh every 30 seconds
  </script>
</body>
</html>

